var sok_id;let init=0;function getPesan(){let e;var a=new Date;let t;$.ajax({type:"ajax",url:base_url+"waku/getPesan",dataType:"json",success:function(n){try{timeline=$("div.timeline"),$("div.clock").remove(),timeline.append("<div><i class='fas fa-comments bg-yellow'></i><div class='timeline-item'><span class='time'><i class='fas fa-clock'></i></span><h3 class='timeline-header'><a href='#'>Mengirim pesan kepada </a></h3><div class='timeline-body'></div><div class='timeline-footer'><a class='btn btn-primary btn-sm'>Mohon jangan ditutup tab yang baru terbuka</a></div></div></div><div class='clock'><i class='fas fa-clock bg-gray'></i></div>"),pesan=n.pesan,url="https://web.whatsapp.com/send?phone=",nomor=pesan[0].DestinationNumber,isipesan=pesan[0].TextDecoded.replace(/ /g,"+"),sok_id=pesan[0].ID,e=!0,t=nomor,isNaN(nomor)?($("span.time").last().append(a.toLocaleTimeString()),$("h3.timeline-header").last().append(nomor),$("div.timeline-body").last().append("Tidak bisa mengirim pesan kepada "+nomor+" karena tidak sesuai dengan prosedur. Mohon diisi nomor pihak dengan baik dan benar.")):($("span.time").last().append(a.toLocaleTimeString()),$("h3.timeline-header").last().append(nomor),$("div.timeline-body").last().append(pesan[0].TextDecoded),setTimeout((function(){update_status_kirim(sok_id),window.open(url+nomor+"&text="+isipesan)}),7e3))}catch(e){$("span.time").last().append(a.toLocaleTimeString()),$("h3.timeline-header").last().append("Tidak ada pesan lagi"),$("div.timeline-body").last().append("Tidak ada yang dikirim. Ambil data yang mau dikirim dulu, tunggu 5 detik"),setTimeout((function(){window.location.replace(base_url+"waku")}),5e3)}},error:function(a){e=!1,$(document).Toasts("create",{class:"bg-danger",title:"Gagal ambil data pesan",subtitle:"Error",body:"Mencoba mengambil data pesan lagi."}),console.log(a),setTimeout((function(){getPesan()}),3e4)},complete:function(){e&&setTimeout((function(){cek_terkirim(sok_id,t)}),2e4)}})}function update_status_kirim(e){$.ajax({type:"POST",url:base_url+"waku/update_status",data:{id:e},dataType:"text",success:function(e){},error:function(e){console.log(e)}})}function deletePesan(e){var a;$.ajax({type:"POST",url:base_url+"waku/deletePesan",data:{id:e},dataType:"json",success:function(e){1==e.success?(a=!0,$("div.timeline-body").last().append("<br>Pesan berhasil dihapus dari outbox.")):$("div.timeline-body").last().append("<br>Gagal hapus pesan dari outbox, mohon periksa internet anda.")},error:function(t){a=!1,console.log(t),$("div.timeline-body").last().append("<br>Gagal hapus pesan, mengulang dalam 30 detik."),setTimeout((function(){deletePesan(e)}),3e4)},complete:function(){a&&setTimeout((()=>{getPesan()}),5e3)}})}function cek_terkirim(e,a){$.ajax({type:"POST",url:base_url+"waku/cek_terkirim",data:{id:e},dataType:"TEXT",beforeSend:function(){},success:function(t){"DeliveryOK"==t?deletePesan(e):"SendingError"==t?($(document).Toasts("create",{class:"bg-danger",title:"Gagal kirim pesan "+a,subtitle:"Error",body:"Pastikan nomor terdaftar di whatsapp, apabila pesan ke nomor lain mengalami error juga, silahkan hubungi administrator"}),deletePesan(e)):setTimeout((function(){cek_terkirim(e,a)}),1e4)},error:function(t){$(document).Toasts("create",{class:"bg-danger",title:"Gagal ambil status pesan",subtitle:"Error",body:"Pastikan tab whatsapp terbuka dan pesan berhasil dikirim."}),console.log(t),setTimeout((function(){cek_terkirim(e,a)}),1e4)}})}function testing(){$.ajax({type:"get",url:base_url+"waku/testing",dataType:"json",success:function(e){let a=e[0],t=new Date,n="SNOW "+a.nama_pa+" "+t,i=!1,s=a.no_testing,o="entahlah";$.ajax({type:"post",url:base_url+"waku/insert_testing",data:{pesan:n,no:s},dataType:"json",beforeSend:function(){$(".loader2").show()},success:function(e){if("ok"==e.status)i=!0;else if("error"==e.status)i=!1;else if("menunggu"==e.status){let a="https://web.whatsapp.com/send?phone=",t=e.id;o="menunggu",update_testing(t),window.open(a+s+"&text="+n)}},error:function(e){console.log(e.responseText)},complete:function(){"menunggu"!=o&&(i?setTimeout((()=>{$(".loader2").hide(),getPesan()}),3e3):i||0!=init?!i&&init>0&&($(".loader2").hide(),$(document).Toasts("create",{class:"bg-danger",title:"Gagal kirim pesan",subtitle:"Error",body:"Pastikan wa web terbuka sepenuhnya, atau dimatikan terlebih dahulu extensi tampermonkey, apabila masih muncul error cek script update pada extensi tampermonkey"})):(init++,setTimeout((()=>{$.ajax({type:"get",url:base_url+"waku/testing_lagi",beforeSend:function(){},success:function(e){},error:function(e){console.log(e.responseText),$(document).Toasts("create",{class:"bg-danger",title:"Oops",subtitle:"Error",body:"Ada yang bermasalah kakak"})},complete:function(){testing()}})}),3e3)))}})}})}function update_testing(e){$.ajax({type:"POST",url:base_url+"waku/cek_testing",data:{id:e},dataType:"TEXT",beforeSend:function(){},success:function(a){"ok"==a?setTimeout((()=>{$(".loader2").hide(),getPesan()}),3e3):"error"==a?($(".loader2").hide(),$(document).Toasts("create",{class:"bg-danger",title:"Gagal kirim pesan",subtitle:"Error",body:"Pastikan wa web terbuka sepenuhnya, atau dimatikan terlebih dahulu extensi tampermonkey"})):setTimeout((function(){update_testing(e)}),1e4)},error:function(a){$(document).Toasts("create",{class:"bg-danger",title:"Gagal ambil status pesan",subtitle:"Error",body:"Pastikan tab whatsapp terbuka dan pesan berhasil dikirim."}),console.log(a),setTimeout((function(){update_testing(e)}),1e4)}})}$("document").ready((function(){$("#sidebar_kirim").addClass("active");var e=new Date;$("span.bg-red").append(e.toLocaleTimeString()),testing()}));